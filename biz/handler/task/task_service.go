// Code generated by hertz generator.

package task

import (
	"context"
	"github.com/cloudwego/hertz/pkg/app"
	"jobor/biz/dal/db"
	"jobor/biz/model"
	"jobor/biz/response"
	task "jobor/kitex_gen/task"
)

// GetTaskAll .
//
//	@Summary		task all get summary
//	@Description	task all get
//	@Tags			task
//	@router			/api/v1/cmdb/tasks [GET]
func GetTaskAll(ctx context.Context, c *app.RequestContext) {
	var err error
	var req task.TaskQuery
	err = c.BindAndValidate(&req)
	if err != nil {
		response.ParamFailed(ctx, c, err)
		//response.SendBaseResp(ctx, c, err)
		return
	}
	var objs []task.TaskAllResp
	resp := response.PageDataList{List: &objs}
	if resp.Total, err = model.DataWithScopes(db.DB.Model(&task.JoborTask{}), task.NameTask, model.Scan,
		resp.List, model.GetScopesList()); err != nil {
		response.SendBaseResp(ctx, c, err)
		return
	}
	response.SendDataResp(ctx, c, response.Succeed, resp)
}

// GetTaskById .
//
//	@Summary		task get by id summary
//	@Description	task get by id
//	@Tags			task
//
//	@router			/api/v1/cmdb/task/{id} [GET]
func GetTaskById(ctx context.Context, c *app.RequestContext) {
	var err error
	_id := c.Params.ByName("id")

	hostResp, err := task.GetTaskInfoById(_id, false)
	if err != nil {
		response.SendBaseResp(ctx, c, err)
		return
	}

	response.SendDataResp(ctx, c, response.Succeed, hostResp)
}

// GetTask .
//
//	@Summary		task get summary
//	@Description	task get
//	@Tags			task
//	@Param			name		query	string	false	"name"
//	@Param			page		query	int		false	"page"
//	@Param			pageSize	query	int		false	"pageSize"
//	@router			/api/v1/cmdb/task [GET]
func GetTask(ctx context.Context, c *app.RequestContext) {
	var err error
	var req task.TaskQuery
	err = c.BindAndValidate(&req)
	if err = c.BindAndValidate(&req); err != nil {
		response.ParamFailed(ctx, c, err)
		return
	}

	var objs task.Tasks

	resp := response.InitPageData(ctx, c, &objs, false)

	if _, err = objs.List(&req, &resp); err != nil {
		response.SendBaseResp(ctx, c, err)
		return
	}
	response.SendDataResp(ctx, c, response.Succeed, resp)
}

// PostTask .
//
//	@Summary		task post summary
//	@Description	task post
//	@Tags			task
//	@Param			json	body	task.PostTaskReq	true	"参数"
//	@router			/api/v1/cmdb/task [POST]
func PostTask(ctx context.Context, c *app.RequestContext) {
	var err error
	var req task.PostTaskReq
	if err = c.BindAndValidate(&req); err != nil {
		response.ParamFailed(ctx, c, err)
		return
	}
	obj, err := task.AddTask(ctx, db.DB, &req)
	if err != nil {
		response.SendBaseResp(ctx, c, err)
		return
	}

	response.SendDataResp(ctx, c, response.Succeed, obj)
}

// PutTask .
//
//	@Summary		task put summary
//	@Description	task put
//	@Tags			task
//	@Param			id		path	int				true	"int valid"
//	@Param			json	body	task.PutTaskReq	true	"参数"
//	@router			/api/v1/cmdb/task/{id} [PUT]
func PutTask(ctx context.Context, c *app.RequestContext) {
	var err error
	var req task.PutTaskReq
	err = c.BindAndValidate(&req)
	if err != nil {
		response.ParamFailed(ctx, c, err)
		return
	}

	_id := c.Params.ByName("id")
	//u, _ := task.GetUserValue(c, false)
	//req.Updater = &u.Nickname
	obj, err := task.ModTask(ctx, db.DB, _id, &req)
	if err != nil {
		response.SendBaseResp(ctx, c, err)
		return
	}

	response.SendDataResp(ctx, c, response.Succeed, obj)
}

// DeleteTask .
//
//	@Summary		task delete summary
//	@Description	task delete
//	@Tags			task
//	@Param			id	path	int	true	"int valid"
//	@router			/api/v1/cmdb/task/{id} [DELETE]
func DeleteTask(ctx context.Context, c *app.RequestContext) {
	var err error
	var req task.TaskQuery
	if err = c.BindAndValidate(&req); err != nil {
		response.ParamFailed(ctx, c, err)
		return
	}
	_id := c.Params.ByName("id")
	if objs, err := task.DelTask(ctx, db.DB, []interface{}{_id}); err != nil {
		response.SendBaseResp(ctx, c, err)
		return
	} else {
		response.SendDataResp(ctx, c, response.Succeed, objs)
	}
}
